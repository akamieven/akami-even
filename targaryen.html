<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta name="color-scheme" content="dark light">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="إقتباسات رواية أغنيَّة الجَليد والنَّار باللغة العربية" />
  <meta name="author" content="Akami Even" />
  <title>إقتباسات رواية أغنية الجليد والنار - آل تارجارين</title>
<meta name="color-scheme" content="light dark">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <link rel="icon" href="https://i.postimg.cc/1zw198Pr/Picsart-25-05-01-18-19-21-090.jpg" type="image/png" />

<link rel="stylesheet" href="style.css">

<style>
    :root {
      --accent-color: #B22222;
    }
  </style>
</head>
<body class="targaryenpic">

  <div class="overlay"></div>

  <header>
       <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
  </header>

 <div id="sidebar-container"></div>
<div id="family-identity" style="display: none;">
    <span id="family-name">العوائل</span>
    <div id="family-logo">
     <img src="https://i.postimg.cc/dQyFZ6Y7/Picsart-25-12-27-09-42-31-523.webp" class="sigils2">
    </div>
</div>

  <div class="content">
    <h1 lang="en">Fire and Blood</h1>
<p style="font-size: 25px;">«النَّار والدَّم»</p>
    <p style="font-size: 45px;">آل تارجارين</p>
     <div class:"inline-controls">
 <a href="index.html" class="home-link">
    <span class="material-symbols-outlined">home</span>
  </a>

  <button class="home-link" onclick="toggleSearch()" title="بحث">
    <span class="material-symbols-outlined">search</span>
  </button>
</div>
<div id="searchPopup" class="search-popup-new">
  <input type="text" id="floatingSearchInput" placeholder="أبحث في الإقتباسات" onkeyup="filterQuotes()">
</div>

       <hr style="width: 100%; opacity: 0.5; margin: 30px auto;">

    <div class="character-section">
      <div class="character" id="dany">
        <img src="https://i.postimg.cc/NM3q7BPr/arantza-sestayo-daenerys.jpg" alt="دنيريس تارجارين">
        <h2>دنيريس تارجارين</h2>
        <div class="quote">
            زحفَ العجوز إلى أول صَفٍّ من المخصيِّين ودمه يتدفَّق على القرميد، لكن المطهَّرين لم يخفضوا أعيُنهم إليه حتى ليُشاهِدوه وهو يموت، وصَفًّا وراء صَفٍّ وراء صَفٍّ ظَلُّوا واقفين.
            هرولَت داني أمامهم وضفيرتها الذَّهبيَّة الفضِّيَّة تُرَفرِف وراءها وجرسها يرنُّ، وصاحَت: «أيها المطهَّرون! اقتُلوا الأسياد الكرام، اقتُلوا الجنود، اقتُلوا كلَّ من يرتدي التوكار أو يحمل سوطًا، لكن لا تُؤذوا طفلًا تحت الثَّانية عشرة، واضربوا قيود كلِّ عبدٍ ترون»، ورفعَت أصابع الهارپي في الهواء... ثم ألقَت السَّوط أرضًا وردَّدت بنبرةٍ كأنها لحن: «الحرية! دراكارس! دراكارس!».
            وهتفوا هُم بأعذب كلمةٍ سمعتها في حياتها: «دراكارس! دراكارس! دراكارس!»، وفي كلِّ مكانٍ حولهم جرى النَّخَّاسون وانتحبوا وتوسَّلوا وماتوا، وامتلأَ الهواء المغبَّر بالحِراب والنِّيران.
            <cite>-عاصفة السيوف-</cite>
          <button class="copy-btn" onclick="copyToClipboard(this)">نسخ</button>
        </div>
      </div>
    </div>
  </div>

<script>
fetch('sidebar.html')
  .then(response => response.text())
  .then(data => {
    document.getElementById('sidebar-container').innerHTML = data;

    // حقن الهوية
    const familyNameSpan = document.getElementById('family-name');
    const familyLogoDiv = document.getElementById('family-logo');
    const sidebarTitle = document.getElementById('sidebar-title');

    if (sidebarTitle && familyNameSpan && familyLogoDiv) {
      sidebarTitle.innerHTML = `<span>${familyNameSpan.innerText}</span> ${familyLogoDiv.innerHTML}`;
    }

    // تفعيل السيوف
    const template = document.getElementById('sword-template');
    if (template) {
       const swordContent = template.innerHTML;
       document.querySelectorAll('.sword-icon').forEach(icon => {
         icon.innerHTML = swordContent;
       });
    }

    // تفعيل القوائم
    document.querySelectorAll('.dropbtn').forEach(button => {
      button.addEventListener('click', function (e) {
        e.stopPropagation();
        const family = this.parentElement;
        document.querySelectorAll('.family').forEach(f => {
          if (f !== family) f.classList.remove('open');
        });
        family.classList.toggle('open');
      });
    });
  })
  .catch(error => console.error('Error loading sidebar:', error));

// --- الدوال العامة ---

// 1. دالة البحث والفلترة المحدثة
function toggleSearch() {
  const popup = document.getElementById('searchPopup');
  const input = document.getElementById('floatingSearchInput');
  
  popup.classList.toggle('active');
  
  if (popup.classList.contains('active')) {
    input.focus();
  } else {
    input.value = ''; 
    filterQuotes(); 
  }
}

// دالة تصفية الاقتباسات وتمييز الكلمات
function filterQuotes() {
  const input = document.getElementById('floatingSearchInput');
  const filter = input.value.trim().toLowerCase();
  const characters = document.querySelectorAll('.character');

  characters.forEach(char => {
    let charHasVisibleQuotes = false;
    const quotes = char.querySelectorAll('.quote');

    quotes.forEach(quote => {
      // حفظ النص الأصلي لمنع تداخل عمليات البحث
      if (!quote.dataset.originalText) {
        quote.dataset.originalText = quote.innerHTML;
      }
      
      const originalHTML = quote.dataset.originalText;
      // تنظيف النص للبحث بدون تأثير الوسوم
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = originalHTML;
      const plainText = tempDiv.innerText.toLowerCase();

      if (filter === "") {
        // إعادة الحالة الطبيعية
        quote.innerHTML = originalHTML;
        quote.style.display = "";
        charHasVisibleQuotes = true;
      } else if (plainText.includes(filter)) {
        // إظهار الاقتباس المطابق فقط
        quote.style.display = "";
        charHasVisibleQuotes = true;
        
        // تمييز الكلمة داخل النص
        highlightText(quote, filter);
      } else {
        // إخفاء الاقتباس غير المطابق
        quote.style.display = "none";
      }
    });

    // التحكم في ظهور الشخصية (تظهر فقط إذا كان لها اقتباس مطابق)
    if (charHasVisibleQuotes) {
      char.style.display = "";
      if (char.previousElementSibling && char.previousElementSibling.tagName === 'HR') {
        char.previousElementSibling.style.display = "";
      }
    } else {
      char.style.display = "none";
      if (char.previousElementSibling && char.previousElementSibling.tagName === 'HR') {
        char.previousElementSibling.style.display = "none";
      }
    }
  });
}

// دالة تمييز النص (Highlight)
function highlightText(element, filter) {
  const originalHTML = element.dataset.originalText;
  // استخدام RegExp للبحث عن الكلمة مع تجاهل حالة الأحرف
  const regex = new RegExp(`(${filter})`, 'gi');
  
  // استبدال النص مع الحفاظ على التنسيق
  // ملاحظة: الـ regex هنا بسيط، سيقوم بتمييز الكلمات حتى لو كانت جزءاً من الروابط
  element.innerHTML = originalHTML.replace(regex, '<mark>$1</mark>');
}

// 2. دالة فتح القائمة الجانبية
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar) sidebar.classList.toggle('visible');
}

// 3. إغلاق القائمة عند النقر خارجها
document.addEventListener('click', function(event) {
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.querySelector('.menu-toggle');
  if (sidebar && sidebar.classList.contains('visible') && !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
    sidebar.classList.remove('visible');
  }
});

// 4. دالة نسخ الاقتباس
function copyToClipboard(button) {
  // ننسخ النص من الداتا الأصلية لضمان عدم نسخ كلمة "تم النسخ" أو وسوم الـ <mark>
  const quoteDiv = button.parentElement;
  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = quoteDiv.dataset.originalText || quoteDiv.innerHTML;
  
  // إزالة زر النسخ من النص المنسوخ
  const btnInTemp = tempDiv.querySelector('.copy-btn');
  if(btnInTemp) btnInTemp.remove();
  
  let textToCopy = tempDiv.innerText.trim();
  
  navigator.clipboard.writeText(textToCopy).then(() => {
    const originalText = button.textContent;
    button.textContent = "تم النسخ";
    setTimeout(() => button.textContent = originalText, 1500);
  });
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 1. قراءة الكلمة من الرابط
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');

    if (query) {
        const searchText = decodeURIComponent(query).trim();
        // نحدد منطقة البحث (داخل المحتوى فقط لتجنب القوائم الجانبية)
        const contentArea = document.querySelector('.content') || document.body;

        if(searchText.length > 0) {
            // استدعاء دالة البحث والتلوين
            highlightTextRecursive(contentArea, searchText);
        }
    }
});

// دالة البحث داخل العناصر
function highlightTextRecursive(element, text) {
    if (element.hasChildNodes()) {
        for (let i = 0; i < element.childNodes.length; i++) {
            const child = element.childNodes[i];
            
            // تجاهل وسوم السكربت والستايل والصور
            if (['SCRIPT', 'STYLE', 'TEXTAREA', 'IMG', 'SVG'].includes(child.nodeName)) continue;
            
            // بحث عميق (Recursive) - إذا وجد نتيجة يتوقف ويعيد true
            if (highlightTextRecursive(child, text)) return true;
        }
    } else if (element.nodeType === 3) { // 3 تعني عقدة نصية (Text Node)
        const innerText = element.nodeValue;
        const index = innerText.toLowerCase().indexOf(text.toLowerCase());
        
        if (index >= 0) {
            // إنشاء عنصر سبان جديد ليحل محل النص القديم
            const wrapper = document.createElement('span');
            
            const before = innerText.substring(0, index);
            const match = innerText.substring(index, index + text.length);
            const after = innerText.substring(index + text.length);
            
            // وضع HTML الجديد: النص السابق + الماركر مع زر X + النص اللاحق
            // (يعتمد على كلاسات CSS التي قمت بإضافتها مسبقاً)
            wrapper.innerHTML = `${before}<span class="custom-marker" id="active-marker">${match}<span class="marker-close" onclick="removeMyHighlight(this)" title="إزالة">✕</span></span>${after}`;
            
            // استبدال النص الأصلي بالعنصر الجديد
            element.replaceWith(wrapper);
            
            // التمرير (Scroll) التلقائي لمكان الكلمة
            setTimeout(() => {
                const marker = document.getElementById('active-marker');
                if (marker) {
                    marker.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }, 500);

            return true; // تم العثور على النص وتلوينه، نتوقف هنا
        }
    }
    return false;
}

// دالة حذف التظليل عند الضغط على X
function removeMyHighlight(btn) {
    const marker = btn.parentElement; // العنصر الملون (الأب)
    
    // الحصول على النص الأصلي (الكلمة الملونة فقط، لأنها أول عنصر ابن للماركر)
    const originalText = marker.childNodes[0].textContent; 
    
    // إنشاء عقدة نصية عادية
    const textNode = document.createTextNode(originalText);
    
    // استبدال الماركر (والزر داخله) بالنص العادي فقط
    marker.parentNode.replaceChild(textNode, marker);
    
    // تنظيف الرابط في شريط العنوان (إزالة ?q=...)
    const cleanUrl = window.location.href.split('?')[0];
    window.history.replaceState(null, null, cleanUrl);
}
</script>

</body>
</html>